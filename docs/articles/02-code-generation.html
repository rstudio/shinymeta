<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code generation • shinymeta</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Code generation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shinymeta</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-motivation.html">shinymeta overview</a>
    </li>
    <li>
      <a href="../articles/02-code-generation.html">Code generation</a>
    </li>
    <li>
      <a href="../articles/03-code-distribution.html">Code distribution</a>
    </li>
    <li>
      <a href="../articles/04-case-studies.html">Case studies</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Code generation</h1>
                        <h4 class="author">Carson Sievert &amp; Joe Cheng</h4>
            
            <h4 class="date">2019-06-28</h4>
      
      
      <div class="hidden name"><code>02-code-generation.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre.R {
  background-color: #d3f3df;
}
</style>
<p>This vignette covers the nuts and bolts of generating code with <strong>shinymeta</strong>.</p>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Meta-fying the cranview app</h2>
<p>Here’s a reduced version of the <a href="https://github.com/cpsievert/cranview">cranview</a> <strong>shiny</strong> app that allows you to enter an R package name to generate a plot of its CRAN downloads over the past year. This app will help us demonstrates how <strong>shinymeta</strong> can help us create a <strong>shiny</strong> app that generates R code to reproduce the things within the shiny app (for example, <code>output$plot</code>), without having to repeat any of the app’s essential logic.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(shiny)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>ui &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/fluidPage">fluidPage</a></span>(</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/textInput">textInput</a></span>(<span class="st">"package"</span>, <span class="st">"Package name"</span>, <span class="dt">value =</span> <span class="st">"ggplot2"</span>),</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/plotOutput">plotOutput</a></span>(<span class="st">"plot"</span>)</span>
<span id="cb1-8"><a href="#cb1-8"></a>)</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {</span>
<span id="cb1-11"><a href="#cb1-11"></a>  </span>
<span id="cb1-12"><a href="#cb1-12"></a>  downloads &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/reactive">reactive</a></span>({</span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="co"># Retrieve a year's worth of daily download data</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb1-15"><a href="#cb1-15"></a>  })</span>
<span id="cb1-16"><a href="#cb1-16"></a>  </span>
<span id="cb1-17"><a href="#cb1-17"></a>  downloads_rolling &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/reactive">reactive</a></span>({</span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="co"># Convert daily data to 7 day rolling average</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb1-20"><a href="#cb1-20"></a>  })</span>
<span id="cb1-21"><a href="#cb1-21"></a>  </span>
<span id="cb1-22"><a href="#cb1-22"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/renderPlot">renderPlot</a></span>({</span>
<span id="cb1-23"><a href="#cb1-23"></a>    <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">downloads_rolling</span>(), <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span>
<span id="cb1-24"><a href="#cb1-24"></a>  })</span>
<span id="cb1-25"><a href="#cb1-25"></a>}</span>
<span id="cb1-26"><a href="#cb1-26"></a></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/shinyApp">shinyApp</a></span>(ui, server)</span></code></pre></div>
<p>Below is one way the app above could be modified to generate code that reproduces <code>output$plot</code> outside of the shiny session. Notice how both the <code>output$plot</code> and <code>output$code</code> update dynamically in response to new package names without having to repeat the logic behind the original app. To keep the focus on code generation, we’ve presented the <code>output$code</code> as simple as possible here (by using <code><a href="https://www.rdocumentation.org/packages/shiny/topics/verbatimTextOutput">verbatimTextOutput()</a></code> and <code><a href="https://www.rdocumentation.org/packages/shiny/topics/renderPrint">renderPrint()</a></code>), but the <a href="03-code-distribution.html">next vignette</a> outlines the various options for presenting and distributing code to users with <strong>shinymeta</strong>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(shiny)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(shinymeta)</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a>ui &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/fluidPage">fluidPage</a></span>(</span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/textInput">textInput</a></span>(<span class="st">"package"</span>, <span class="st">"Package name"</span>, <span class="dt">value =</span> <span class="st">"ggplot2"</span>),</span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/verbatimTextOutput">verbatimTextOutput</a></span>(<span class="st">"code"</span>),</span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/plotOutput">plotOutput</a></span>(<span class="st">"plot"</span>)</span>
<span id="cb2-10"><a href="#cb2-10"></a>)</span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {</span>
<span id="cb2-13"><a href="#cb2-13"></a>  downloads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="st">"# Retrieve a year's worth of daily download data"</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb2-16"><a href="#cb2-16"></a>  })</span>
<span id="cb2-17"><a href="#cb2-17"></a>  </span>
<span id="cb2-18"><a href="#cb2-18"></a>  downloads_rolling &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="st">"# Convert daily data to 7 day rolling average"</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="op">!!</span><span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb2-21"><a href="#cb2-21"></a>  })</span>
<span id="cb2-22"><a href="#cb2-22"></a>  </span>
<span id="cb2-23"><a href="#cb2-23"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaRender.html">metaRender</a></span>(renderPlot, {</span>
<span id="cb2-24"><a href="#cb2-24"></a>    <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="op">!!</span><span class="kw">downloads_rolling</span>(), <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span>
<span id="cb2-25"><a href="#cb2-25"></a>  })</span>
<span id="cb2-26"><a href="#cb2-26"></a>  </span>
<span id="cb2-27"><a href="#cb2-27"></a>  output<span class="op">$</span>code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/renderPrint">renderPrint</a></span>({</span>
<span id="cb2-28"><a href="#cb2-28"></a>    <span class="kw"><a href="../reference/expandCode.html">expandObjects</a></span>(</span>
<span id="cb2-29"><a href="#cb2-29"></a>      <span class="kw">downloads</span>(),</span>
<span id="cb2-30"><a href="#cb2-30"></a>      <span class="kw">downloads_rolling</span>(),</span>
<span id="cb2-31"><a href="#cb2-31"></a>      output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(),</span>
<span id="cb2-32"><a href="#cb2-32"></a>      <span class="dt">.pkgs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"ggplot2"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb2-33"><a href="#cb2-33"></a>    )</span>
<span id="cb2-34"><a href="#cb2-34"></a>  })</span>
<span id="cb2-35"><a href="#cb2-35"></a>}</span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/shinyApp">shinyApp</a></span>(ui, server)</span></code></pre></div>
<div align="center">
<p><img src="cranview-basic.gif" width="90%"></p>
</div>
<p>So, what has changed in the implementation between the original <strong>shiny</strong> app and the one that generates code? There a few high-level observations we can make here that should hold true for most apps that leverage <strong>shinymeta</strong> to generate code:</p>
<ul>
<li>Each <code><a href="https://www.rdocumentation.org/packages/shiny/topics/reactive">reactive()</a></code> has changed to <code><a href="../reference/metaReactive.html">metaReactive()</a></code>, and the <code><a href="https://www.rdocumentation.org/packages/shiny/topics/renderPlot">renderPlot()</a></code> function has been jammed into a <code><a href="../reference/metaRender.html">metaRender()</a></code> function.
<ul>
<li>Note: this example doesn’t use <code><a href="https://www.rdocumentation.org/packages/shiny/topics/observe">observe()</a></code>, but this document <a href="#observers">covers their translation as well</a>.</li>
</ul>
</li>
<li>Each read of a <code><a href="../reference/metaReactive.html">metaReactive()</a></code> or an <code>input</code> value has been prepended with <code>!!</code>.</li>
<li>Comments are retained by surrounding them in quotes.</li>
<li>The <code><a href="../reference/expandCode.html">expandObjects()</a></code> function generates code from a chain of meta-reactives (e.g., <code>downloads()</code> -&gt; <code>downloads_rolling()</code> -&gt; <code>output$plot()</code>).</li>
</ul>
<p>On the surface, these changes look somewhat straight-forward, but in order to really understand how it all fits together, we’ll have to unpack a handful of pretty sophisticated concepts related to metaprogramming (i.e., writing code that generates code). If you’re new to metaprogramming, and you’re serious about using <strong>shinymeta</strong>, we recommend reading <a href="https://adv-r.hadley.nz">Advanced R</a> (especially the <a href="https://adv-r.hadley.nz/quasiquotation.html">Quasi-quotation chapter</a>), but that shouldn’t be necessary to get the gist of what’s happening in this vignette.</p>
</div>
<div id="meta-reactives" class="section level2">
<h2 class="hasAnchor">
<a href="#meta-reactives" class="anchor"></a>Meta-reactives</h2>
<p>Let’s start with this particular reactive expression from the original app:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>downloads &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/reactive">reactive</a></span>({</span>
<span id="cb3-2"><a href="#cb3-2"></a>  cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb3-3"><a href="#cb3-3"></a>})</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">downloads</span>()</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&gt;         date count package</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#&gt; 1 2018-06-28 15742 ggplot2</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&gt; 2 2018-06-29 13435 ggplot2</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">#&gt; 3 2018-06-30  7963 ggplot2</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&gt; 4 2018-07-01  8599 ggplot2</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#&gt; 5 2018-07-02 15758 ggplot2</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#&gt; 6 2018-07-03 20244 ggplot2</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">#&gt; [...plus 360 more rows...]</span></span></code></pre></div>
<p>Reactive expressions are fantastic at the job they were designed for: lazy, caching, reactivity-aware calculators of results. However, they don’t help in the second part of our goal, which is extracting the essential logic of the app, and making it reusable for others outside of shiny.</p>
<p>Enter <code><a href="../reference/metaReactive.html">metaReactive()</a></code>. Let’s do nothing besides change <code><a href="https://www.rdocumentation.org/packages/shiny/topics/reactive">reactive()</a></code> to <code><a href="../reference/metaReactive.html">metaReactive()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>downloads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb4-2"><a href="#cb4-2"></a>  cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb4-3"><a href="#cb4-3"></a>})</span></code></pre></div>
<p>In normal usage, the behavior of <code>downloads()</code> doesn’t change at all – it still works exactly the same as it lazily, cachingly, reactivity-aware-ingly calculates results.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">downloads</span>()</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#&gt;         date count package</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">#&gt; 1 2018-06-28 15742 ggplot2</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#&gt; 2 2018-06-29 13435 ggplot2</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">#&gt; 3 2018-06-30  7963 ggplot2</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">#&gt; 4 2018-07-01  8599 ggplot2</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&gt; 5 2018-07-02 15758 ggplot2</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#&gt; 6 2018-07-03 20244 ggplot2</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#&gt; [...plus 360 more rows...]</span></span></code></pre></div>
<p>However, when invoked with <strong>shinymeta</strong>’s meta-mode enabled (i.e., <code><a href="../reference/withMetaMode.html">withMetaMode()</a></code>), the behavior changes: Instead of evaluating the reactive expression and returning the value (a data frame), it returns a code expression. To make it visually clear when we’re generating a code expression, this vignette will set the background color of generated code to <svg width="1em" height="1em"><rect width="1em" height="1em" style="fill: #d3f3df"></rect></svg>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">downloads</span>())</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span></code></pre></div>
<p>Notice how the generated code depends on the input variable <code>input$package</code>. If we were to run this code in a new R session, it would error because <code>input$package</code> isn’t defined outside of the shiny session. We can, however, replace the literal name “<code>input$package</code>” with the value it represents (by unquoting it with <code>!!</code>), which allows the code to run a context where <code>input</code> isn’t defined.</p>
</div>
<div id="unquoting" class="section level2">
<h2 class="hasAnchor">
<a href="#unquoting" class="anchor"></a>Unquoting with <code>!!</code>
</h2>
<p>In computing, functions that return code expressions (e.g., <code><a href="../reference/metaReactive.html">metaReactive()</a></code>) are called quoting functions. Since <strong>shinymeta</strong> supports <a href="https://adv-r.hadley.nz/quasiquotation.html">tidy evaluation</a>, quoting functions are also quasi-quoting functions, meaning they allow you to selectively evaluate (i.e., unquote or expand) parts of a quoted expression. For simple example, consider the <code><a href="https://ggplot2.tidyverse.org/reference/tidyeval.html">expr()</a></code> function from the <strong>rlang</strong> package which allow you to create code expressions:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rlang)</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a>a &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw"><a href="https://rlang.r-lib.org/reference/quotation.html">expr</a></span>(a <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>a <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<p>One way to produce an equivalent code expression that doesn’t depend on the object <code>a</code> existing would be to use the <code>!!</code> operator to unquote (aka, evaluate or expand) the symbol <code>a</code>, which replaces it with the value it represents:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw"><a href="https://rlang.r-lib.org/reference/quotation.html">expr</a></span>(<span class="op">!!</span>a <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<p>The idea is essentially the same when we wish to insert the value of <code>input$package</code> into the code rather than the literal name “<code>input$package</code>”.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>downloads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb12-2"><a href="#cb12-2"></a>  cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb12-3"><a href="#cb12-3"></a>})</span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">downloads</span>())</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span></code></pre></div>
<p>Depending on the ultimate purpose of the script we generate, we may or may not also want to replace a <code><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date()</a></code> call (which returns the current date) the actual value (at run time). For example, we produce code that acquires downloads starting <code>from</code> a year prior to the date the code <em>was generated</em> and <code>to</code> whenever the code is <em>actually run</em>. The former requires us to un-quote <code><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date()</a></code> whereas the latter doesn’t.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Ask yourself: what's the difference between `rlang::expr(!!Sys.Date() - 365)` and `rlang::expr(!!(Sys.Date() - 365))`?</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co"># Why is that difference important in this case?</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>downloads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb14-4"><a href="#cb14-4"></a>  cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="op">!!</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>), <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb14-5"><a href="#cb14-5"></a>})</span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">downloads</span>())</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/structure">structure</a></span>(<span class="dv">17710</span>, <span class="dt">class =</span> <span class="st">"Date"</span>), <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span></code></pre></div>
<p>Whoa, what’s this <code><a href="https://www.rdocumentation.org/packages/base/topics/structure">structure()</a></code> business? Well, it’s an unfortunate consequence of deparsing values that contain attributes (e.g., <code><a href="https://www.rdocumentation.org/packages/base/topics/deparse">deparse(Sys.Date())</a></code>), and deparsing is necessary for <a href="#comments">supporting comments</a> and formatting code. In this case, since the <code>from</code> argument accepts string in <code>"yyyy-mm-dd"</code> format (i.e., the <code>Date</code> class isn’t necessary), we can use <code><a href="https://www.rdocumentation.org/packages/base/topics/format">format()</a></code> to coerce the <code>Date</code> object into a string (and thus, more human-readable).</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>downloads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb16-2"><a href="#cb16-2"></a>  cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="op">!!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/format">format</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>), <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb16-3"><a href="#cb16-3"></a>})</span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">downloads</span>())</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="st">"2018-06-28"</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span></code></pre></div>
<blockquote>
<h4 id="takeaway-unquote-reactive-inputsvalues-e.g.-inputpackage">Takeaway: unquote reactive inputs/values (e.g., <code>!!input$package</code>)</h4>
</blockquote>
<p>In summary, unquoting replaces a name with the value that it represents; and thus, is a essential tool for generating code that can run outside of a shiny session. That’s because, in a shiny app, we often refer to reactive values that are only defined inside a shiny runtime. Unquoting is fairly straightforward when the name you’re unquoting (<code>e.g. input$package</code>) represents a constant value (e.g. <code>"ggplot2"</code>), but become more complicated when those values become more complicated. In the next section, we’ll be chaining meta-reactive expressions, which requires unquoting names that represent meta-reactives. That means, these names can actually represent un-evaluated expressions!</p>
</div>
<div id="chaining-meta-reactives" class="section level2">
<h2 class="hasAnchor">
<a href="#chaining-meta-reactives" class="anchor"></a>Chaining meta-reactives</h2>
<p>Chaining of reactive expressions is a very useful pattern that allows <strong>shiny</strong> to intelligently cache computations for you. Note that our example app has a reactive chain: the acquistion of daily downloads is done in one reactive expression, <code>downloads()</code>, then <code>downloads_rolling()</code> uses the return value of <code>downloads()</code> to compute a weekly rolling average:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>downloads_rolling &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb18-3"><a href="#cb18-3"></a>})</span></code></pre></div>
<p>Recall that, when invoked with <a href="#meta-mode">meta-mode</a> enabled, <code><a href="../reference/metaReactive.html">metaReactive()</a></code>, like <code><a href="https://rlang.r-lib.org/reference/quotation.html">rlang::expr()</a></code>, quotes its input, which is why <code>downloads()</code> appears in the code produced by <code>downloads_rolling()</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">downloads_rolling</span>())</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">downloads</span>() <span class="op">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span></code></pre></div>
<p>So, similar to the problem we had before with <code>input$package</code>, the generated code relies on something that won’t be defined in a new R session (<code>downloads()</code>). However, by unquoting <code>downloads()</code>, we can replace it with the value it represents. Since <code>downloads()</code> is a <code><a href="../reference/metaReactive.html">metaReactive()</a></code>, when meta-mode is enabled, that value represents the unevaluated expression that <code><a href="../reference/withMetaMode.html">withMetaMode(downloads())</a></code> returns:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>downloads_rolling &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive</a></span>({</span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="op">!!</span><span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb21-3"><a href="#cb21-3"></a>})</span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">downloads_rolling</span>())</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="st">"2018-06-28"</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>()) <span class="op">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span></code></pre></div>
<blockquote>
<h4 id="takeaway-unquote-meta-reactive-reads-i.e.-downloads-that-appear-within-other-meta-reactives">Takeaway: unquote meta-reactive reads (i.e., <code>!!downloads()</code>) that appear within other meta-reactives</h4>
</blockquote>
</div>
<div id="observers" class="section level2">
<h2 class="hasAnchor">
<a href="#observers" class="anchor"></a>Other meta-reactives (observers &amp; outputs)</h2>
<p>So far we’ve learned how to manage reactive values (e.g., <code>input$package</code>) and reactive expressions (e.g., <code>downloads()</code>), but what about code captured in the endpoints of shiny’s reactivity model (i.e. observers and outputs)?</p>
<div align="center">
<p><img src="reactivity-graph-00.png" width="60%"></p>
</div>
<div id="observers-1" class="section level4">
<h4 class="hasAnchor">
<a href="#observers-1" class="anchor"></a>Observers</h4>
<p>Creating a meta variant of <code><a href="https://www.rdocumentation.org/packages/shiny/topics/observe">observe()</a></code> is very similar to creating a meta variant of <code><a href="https://www.rdocumentation.org/packages/shiny/topics/reactive">reactive()</a></code>: use <code><a href="../reference/metaObserve.html">metaObserve()</a></code> instead of <code><a href="https://www.rdocumentation.org/packages/shiny/topics/observe">observe()</a></code> and unquote any references to reactive values or expressions. Note that, outside of meta mode, <code><a href="../reference/metaObserve.html">metaObserve()</a></code> behaves the same as <code><a href="https://www.rdocumentation.org/packages/shiny/topics/observe">observe()</a></code>: it immediately evaluates the given expression (i.e., there’s no need to invoke <code>msgObs()</code> outside of meta mode).</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>msgObs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaObserve.html">metaObserve</a></span>({</span>
<span id="cb23-2"><a href="#cb23-2"></a>  d &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="st">" has an daily download average of "</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(d<span class="op">$</span>count))</span>
<span id="cb23-4"><a href="#cb23-4"></a>})</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(<span class="kw">msgObs</span>())</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>d &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="st">"2018-06-28"</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"ggplot2"</span>, <span class="st">" has an daily download average of "</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(d<span class="op">$</span>count))</span></code></pre></div>
<p>The traditional <code><a href="https://www.rdocumentation.org/packages/shiny/topics/observe">observe()</a></code> function returns an object that can be used to control aspects of the observer, though most <strong>shiny</strong> apps don’t bother to save it. See <code><a href="https://www.rdocumentation.org/packages/shiny/topics/observe">?observe</a></code> for the different methods available. The object returned from <code><a href="../reference/metaObserve.html">metaObserve()</a></code> can be used in the same way (<code>msgObs$suspend()</code>, for example) but has the additional capability of being called like a function, as in the previous code example.</p>
</div>
<div id="outputs" class="section level4">
<h4 class="hasAnchor">
<a href="#outputs" class="anchor"></a>Outputs</h4>
<p>Since package authors are allowed to create their own output rendering functions, creating a meta variant of an output renderer (e.g. <code><a href="https://www.rdocumentation.org/packages/shiny/topics/renderPlot">renderPlot()</a></code>) needs to be more general than prefixing <code>meta</code> to the function name (as we did with <code><a href="../reference/metaReactive.html">metaReactive()</a></code> and <code><a href="../reference/metaObserve.html">metaObserve()</a></code>). Therefore, <strong>shinymeta</strong> has a general-purpose <code><a href="../reference/metaRender.html">metaRender()</a></code> function that anticipates a rendering function in it’s first argument, and an expression in the second argument. Here’s how we can make a meta variant of out downloads plot:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaRender.html">metaRender</a></span>(renderPlot, {</span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="op">!!</span><span class="kw">downloads_rolling</span>(), <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span>
<span id="cb25-3"><a href="#cb25-3"></a>})</span></code></pre></div>
<p>Similar to <code><a href="../reference/metaReactive.html">metaReactive()</a></code> and <code><a href="../reference/metaObserve.html">metaObserve()</a></code>, when meta mode is enabled, you can call <code>output$OUTPUT_ID()</code> to get an unevaluated expression.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw"><a href="../reference/withMetaMode.html">withMetaMode</a></span>(output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>())</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="st">"2018-06-28"</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>()) <span class="op">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>)), <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span></code></pre></div>
<p>(<code><a href="../reference/metaRender.html">metaRender()</a></code> makes some assumptions about the arguments taken by the render function, assumptions that we believe are true for all existing render functions. If you encounter a render function that doesn’t seem to work properly with <strong>shinymeta</strong>, please let us know by <a href="https://github.com/rstudio/shinymeta/issues">filing an issue on GitHub</a>.)</p>
</div>
</div>
<div id="ignoring-code" class="section level2">
<h2 class="hasAnchor">
<a href="#ignoring-code" class="anchor"></a>Ignoring code</h2>
<p>Often times, for more sophisticated apps, you’ll want to completely ignore part(s) of a reactive expression that are only relevant inside a shiny runtime. One common example is <strong>shiny</strong>’s input validation helpers (e.g. <code><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">validate()</a></code>, <code><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">need()</a></code>, and <code><a href="https://www.rdocumentation.org/packages/shiny/topics/req">req()</a></code>), which you probably don’t want to include in your generated code. For this reason, <strong>shinymeta</strong> provides a second version of each meta-reactive (e.g., <code><a href="../reference/metaReactive.html">metaReactive2()</a></code>, <code><a href="../reference/metaObserve.html">metaObserve2()</a></code>, <code>metaRender2()</code>, etc), which allows you capture a specific subset of a reactive expression via <code><a href="../reference/metaExpr.html">metaExpr()</a></code> (otherwise, they behave exactly the same).</p>
<p>To demonstrate, our example app could make use of <code><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">validate()</a></code> and <code><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">need()</a></code> to improve the user experience of our app, since currently, it errors out when a user hasn’t specified a package name.</p>
<div align="center">
<p><img src="cranview-error.gif" width="80%"></p>
</div>
<p>To ignore the <code>validate</code> and <code><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">need()</a></code> calls, change <code><a href="../reference/metaRender.html">metaRender()</a></code> to <code>metaRender2()</code>, then wrap the plot generation code in <code><a href="../reference/metaExpr.html">metaExpr()</a></code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: this doesn't yield the right thing!</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">metaRender2</span>(renderPlot, {</span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">validate</a></span>(</span>
<span id="cb28-4"><a href="#cb28-4"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">need</a></span>(input<span class="op">$</span>package, <span class="st">"Please provide a package name"</span>),</span>
<span id="cb28-5"><a href="#cb28-5"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/validate">need</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(<span class="kw">downloads</span>()) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="st">"Please provide a valid package name"</span>)</span>
<span id="cb28-6"><a href="#cb28-6"></a>  )</span>
<span id="cb28-7"><a href="#cb28-7"></a>  </span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="kw"><a href="../reference/metaExpr.html">metaExpr</a></span>({</span>
<span id="cb28-9"><a href="#cb28-9"></a>    <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="op">!!</span><span class="kw">downloads_rolling</span>(), <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span>
<span id="cb28-10"><a href="#cb28-10"></a>  })</span>
<span id="cb28-11"><a href="#cb28-11"></a>})</span></code></pre></div>
<p>It isn’t really needed in this case, but you could also re-work <code>downloads()</code> and <code>downloads_rolling()</code> to perform input validation:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>downloads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive2</a></span>({</span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/req">req</a></span>(input<span class="op">$</span>package)</span>
<span id="cb29-3"><a href="#cb29-3"></a>  </span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="kw"><a href="../reference/metaExpr.html">metaExpr</a></span>({</span>
<span id="cb29-5"><a href="#cb29-5"></a>    cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb29-6"><a href="#cb29-6"></a>  })</span>
<span id="cb29-7"><a href="#cb29-7"></a>})</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a>downloads_rolling &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaReactive.html">metaReactive2</a></span>({</span>
<span id="cb29-10"><a href="#cb29-10"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/shiny/topics/req">req</a></span>(<span class="kw">downloads</span>())</span>
<span id="cb29-11"><a href="#cb29-11"></a>  </span>
<span id="cb29-12"><a href="#cb29-12"></a>  <span class="kw"><a href="../reference/metaExpr.html">metaExpr</a></span>({</span>
<span id="cb29-13"><a href="#cb29-13"></a>    <span class="op">!!</span><span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb29-14"><a href="#cb29-14"></a>  })</span>
<span id="cb29-15"><a href="#cb29-15"></a>})</span></code></pre></div>
<p>It’s important to note that these <code>...2</code> variants expect their return value to be a <code><a href="../reference/metaExpr.html">metaExpr()</a></code>. If you find yourself in the situation where that <code><a href="../reference/metaExpr.html">metaExpr()</a></code> should change depending on some sort of control flow (e.g., <code>if</code> statements), you may want to use a pattern <a href="https://github.com/cpsievert/cranview/blob/f4989a9/app.R#L71-L89">similar to this</a>.</p>
</div>
<div id="putting-it-altogether" class="section level2">
<h2 class="hasAnchor">
<a href="#putting-it-altogether" class="anchor"></a>Putting it altogether</h2>
<p>Now that we’ve translated our <strong>shiny</strong> reactive expressions to their <strong>shinymeta</strong> variants, it’s time to generate chunks of code from numerous meta-reactives. So far, we’ve been inspecting the code that a single meta-reactive produces via <code><a href="../reference/withMetaMode.html">withMetaMode()</a></code>, but this function is inadequate for generating code from several meta-reactives at once. Currently, <strong>shinymeta</strong> provides two other functions for generating code from several meta-reactives at once: <code><a href="../reference/expandCode.html">expandObjects()</a></code> and <code><a href="../reference/expandCode.html">expandCode()</a></code>. The former is a “higher-level” code generation tool that’s easier to use, but depending on what you’re doing you may have to learn to use the latter.</p>
<div id="expandobjects" class="section level3">
<h3 class="hasAnchor">
<a href="#expandobjects" class="anchor"></a><code><a href="../reference/expandCode.html">expandObjects()</a></code>
</h3>
<p>The <code><a href="../reference/expandCode.html">expandObjects()</a></code> function is more or less designed to generate code that mimics a path of reactive execution. This fits the most common use case we anticipate for <strong>shinymeta</strong>: generating code to reproduce specific output(s). In this case, we recommend identifying the chain of reactive expression(s) necessary to generate an output of interest, then feeding those reactives, <strong>in order</strong>, to the <code><a href="../reference/expandCode.html">expandObjects()</a></code> function.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw"><a href="../reference/expandCode.html">expandObjects</a></span>(</span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="kw">downloads</span>(),</span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="kw">downloads_rolling</span>(),</span>
<span id="cb30-4"><a href="#cb30-4"></a>  output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()</span>
<span id="cb30-5"><a href="#cb30-5"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>downloads &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb31-2"><a href="#cb31-2"></a>downloads_rolling &lt;-<span class="st"> </span>downloads <span class="op">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(downloads_rolling, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span></code></pre></div>
<h4 style="color:red">
CAUTION:
</h4>
<p>Make sure you’ve correctly identified the ordering of your reactive expressions. <code><a href="../reference/expandCode.html">expandObjects()</a></code> does nothing to ensure that this ordering is correct, and if it’s not, it will produce code that is incorrect!</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw"><a href="../reference/expandCode.html">expandObjects</a></span>(</span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="kw">downloads_rolling</span>(),</span>
<span id="cb32-3"><a href="#cb32-3"></a>  <span class="kw">downloads</span>(),</span>
<span id="cb32-4"><a href="#cb32-4"></a>  output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()</span>
<span id="cb32-5"><a href="#cb32-5"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>downloads_rolling &lt;-<span class="st"> </span>downloads <span class="op">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb33-3"><a href="#cb33-3"></a>downloads &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(downloads_rolling, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span></code></pre></div>
<p>Once you’ve identified a reactive chain of interest, and placed them in correct order, there are a few other things to consider that can improve the generated code:</p>
<ul>
<li>Make sure to identify any packages that the code relies on and include them in the <code>.pkgs</code> argument.</li>
<li>Add comments by surrounding them in quotes.
<ul>
<li>You can also add comments in the meta-reactives themselves, if you prefer (see the <a href="#example">motivating example</a>).</li>
</ul>
</li>
<li>Use named arguments to name the return value of each <code><a href="../reference/metaReactive.html">metaReactive()</a></code>.
<ul>
<li>If you’d like names in the user-facing code to be different from the names of your meta-reactives.</li>
</ul>
</li>
<li>Consider adding other reactive endpoints that use values from this reactive chain (e.g., <code>output$summary()</code>).</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>output<span class="op">$</span>summary &lt;-<span class="st"> </span><span class="kw"><a href="../reference/metaRender.html">metaRender</a></span>(renderPrint, {</span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>((<span class="op">!!</span><span class="kw">downloads</span>())<span class="op">$</span>count)</span>
<span id="cb34-3"><a href="#cb34-3"></a>})</span>
<span id="cb34-4"><a href="#cb34-4"></a></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="kw"><a href="../reference/expandCode.html">expandObjects</a></span>(</span>
<span id="cb34-6"><a href="#cb34-6"></a>  <span class="st">"# Retrieve a year's worth of daily download data"</span>,</span>
<span id="cb34-7"><a href="#cb34-7"></a>  <span class="dt">downloads_daily =</span> <span class="kw">downloads</span>(),</span>
<span id="cb34-8"><a href="#cb34-8"></a>  <span class="st">"# Convert daily data to 7 day rolling average"</span>,</span>
<span id="cb34-9"><a href="#cb34-9"></a>  <span class="dt">downloads_avg =</span> <span class="kw">downloads_rolling</span>(),</span>
<span id="cb34-10"><a href="#cb34-10"></a>  output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(),</span>
<span id="cb34-11"><a href="#cb34-11"></a>  output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(),</span>
<span id="cb34-12"><a href="#cb34-12"></a>  <span class="dt">.pkgs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"ggplot2"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb34-13"><a href="#cb34-13"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"dplyr"</span>)</span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="co"># Retrieve a year's worth of daily download data</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>downloads_daily &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="co"># Convert daily data to 7 day rolling average</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>downloads_avg &lt;-<span class="st"> </span>downloads_daily <span class="op">%&gt;%</span></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(downloads_avg, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(downloads_daily<span class="op">$</span>count)</span></code></pre></div>
</div>
<div id="expandcode" class="section level3">
<h3 class="hasAnchor">
<a href="#expandcode" class="anchor"></a><code><a href="../reference/expandCode.html">expandCode()</a></code>
</h3>
<p>If <code><a href="../reference/expandCode.html">expandObjects()</a></code> isn’t flexible enough to generate the code you desire, you may want to consider using <code><a href="../reference/expandCode.html">expandCode()</a></code> instead. Similar to the functions we learned about in <a href="#unquoting">Unquoting with <code>!!</code></a>, <code><a href="../reference/expandCode.html">expandCode()</a></code> is a quasi-quoting function, meaning we can selectively evaluate portions of the expression we provide it:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="kw"><a href="../reference/expandCode.html">expandCode</a></span>({</span>
<span id="cb36-2"><a href="#cb36-2"></a>  downloads &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb36-3"><a href="#cb36-3"></a>  downloads_rolling &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads_rolling</span>()</span>
<span id="cb36-4"><a href="#cb36-4"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>downloads &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb37-2"><a href="#cb37-2"></a>downloads_rolling &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>()) <span class="op">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span></code></pre></div>
<p>This yields code that is similar to <code><a href="../reference/expandCode.html">expandObjects(downloads(), downloads_rolling())</a></code>, except that <code><a href="../reference/expandCode.html">expandCode()</a></code> isn’t intelligent enough to know to avoid duplicated code (e.g., <code>cran_downloads()</code> is called twice here). This is problematic for several reasons: (1) it makes the code harder to read and understand, (2) any changes to the logic by the recipient of the code will need to be done thrice, which is both tedious and error-prone, and (3) the duplication of logic may introduce bugs if the logic in <code>downloads()</code> has side effects or returns different results each time it is run (i.e. having an element of randomness). We can, however, teach <code><a href="../reference/expandCode.html">expandCode()</a></code> how to avoid the redundant computation by intercepting (i.e. patching) the usual unquoting (i.e., expanding) rules.</p>
<p>Recall that <code>downloads_rolling()</code> contains a <code>!!downloads()</code>. Since <code>downloads()</code> is a meta-reactive, unquoting it interpolates the result of <code><a href="../reference/withMetaMode.html">withMetaMode(downloads())</a></code> into the result of <code><a href="../reference/withMetaMode.html">withMetaMode(downloads_rolling())</a></code>. However, what we really want is for the unquoting of <code>downloads()</code> <em>inside</em> <code>downloads_rolling()</code> to expand to a symbol (<code>downloads</code>) instead of the result of <code><a href="../reference/withMetaMode.html">withMetaMode(downloads())</a></code>. For this reason, <code><a href="../reference/expandCode.html">expandCode()</a></code> provides a way to override these expansion rules by replacing the unquoted meta-reactives with a name of our choosing in the <code>patchCalls</code> argument.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw"><a href="../reference/expandCode.html">expandCode</a></span>(</span>
<span id="cb38-2"><a href="#cb38-2"></a>  {</span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(<span class="st">'ggplot2'</span>)</span>
<span id="cb38-4"><a href="#cb38-4"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(<span class="st">'dplyr'</span>)</span>
<span id="cb38-5"><a href="#cb38-5"></a>    <span class="st">"# Retrieve a year's worth of daily download data"</span></span>
<span id="cb38-6"><a href="#cb38-6"></a>    d &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb38-7"><a href="#cb38-7"></a>    <span class="st">"# Convert daily data to 7 day rolling average"</span></span>
<span id="cb38-8"><a href="#cb38-8"></a>    downloads_rolling &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads_rolling</span>()</span>
<span id="cb38-9"><a href="#cb38-9"></a>  },</span>
<span id="cb38-10"><a href="#cb38-10"></a>  <span class="dt">patchCalls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</span>
<span id="cb38-11"><a href="#cb38-11"></a>    <span class="dt">downloads =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(d)</span>
<span id="cb38-12"><a href="#cb38-12"></a>  )</span>
<span id="cb38-13"><a href="#cb38-13"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(<span class="st">"dplyr"</span>)</span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="co"># Retrieve a year's worth of daily download data</span></span>
<span id="cb39-4"><a href="#cb39-4"></a>d &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="co"># Convert daily data to 7 day rolling average</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>downloads_rolling &lt;-<span class="st"> </span>d <span class="op">%&gt;%</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span></code></pre></div>
<p>For this example, <code>patchCalls</code> has a single entry: <code>downloads = quote(d)</code>. This means, "anytime <code>downloads()</code> is invoked by a meta-reactive object (or, put another way, anytime <code>!!downloads()</code> appears in another meta-reactive), return the symbol <code>d</code> (instead of the result of <code><a href="../reference/withMetaMode.html">withMetaMode(downloads())</a></code>). This meaning subtly implies that unquoting at the top-level of <code><a href="../reference/expandCode.html">expandCode()</a></code> is not affected by <code>patchCalls</code> (i.e., it’s only the unquoting that happens <em>inside</em> <code>downloads_rolling()</code> that is affected).</p>
<h4 style="color:red">
CAUTION:
</h4>
<p>As with <code><a href="../reference/expandCode.html">expandObjects()</a></code>, it’s entirely possible to produce code that’s incorrect (it suffers from the same ordering issue). In fact, it’s much easier to produce incorrect code with <code><a href="../reference/expandCode.html">expandCode()</a></code> since you have complete control over the expression you’re building.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw"><a href="../reference/expandCode.html">expandCode</a></span>(</span>
<span id="cb40-2"><a href="#cb40-2"></a>  {</span>
<span id="cb40-3"><a href="#cb40-3"></a>    downloads_rolling &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads_rolling</span>()</span>
<span id="cb40-4"><a href="#cb40-4"></a>    pkg_downloads &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb40-5"><a href="#cb40-5"></a>    <span class="op">!!</span>output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()</span>
<span id="cb40-6"><a href="#cb40-6"></a>  }, </span>
<span id="cb40-7"><a href="#cb40-7"></a>  <span class="dt">patchCalls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</span>
<span id="cb40-8"><a href="#cb40-8"></a>    <span class="dt">downloads =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(d)</span>
<span id="cb40-9"><a href="#cb40-9"></a>  )</span>
<span id="cb40-10"><a href="#cb40-10"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>downloads_rolling &lt;-<span class="st"> </span>d <span class="op">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>))</span>
<span id="cb41-3"><a href="#cb41-3"></a>pkg_downloads &lt;-<span class="st"> </span>cranlogs<span class="op">::</span><span class="kw"><a href="https://r-hub.github.io/cranlogs/reference/cran_downloads.html">cran_downloads</a></span>(<span class="st">"ggplot2"</span>, <span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>())</span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(d <span class="op">%&gt;%</span></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zoo/topics/rollapply">rollapply</a></span>(count, <span class="dv">7</span>, mean, <span class="dt">fill =</span> <span class="st">"extend"</span>)), <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span></code></pre></div>
<p>You might be thinking, <code><a href="../reference/expandCode.html">expandCode()</a></code> seems weird and complicated (it is!), why should I even bother learning how to use it? For one, you might want to generate code that combines multiple outputs in some custom way, like <a href="03-code-distribution.html#numerous-outputs">this example in the next vignette</a>. Also, <code><a href="../reference/expandCode.html">expandCode()</a></code> gives you the abilty to ‘short-cut’ reactive logic, which is probably most useful for generating code for <a href="03-code-distribution.html#bundling">reports</a> where it’s not ideal to expose all your code, just some portion of it (whether it’s for proprietary and/or efficiency reasons). For example, when a user downloads the report, you might want to save an R object to disk (e.g., <code><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">saveRDS()</a></code>), then have the generated code read in that object.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="kw"><a href="../reference/expandCode.html">expandCode</a></span>(</span>
<span id="cb42-2"><a href="#cb42-2"></a>  {</span>
<span id="cb42-3"><a href="#cb42-3"></a>    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb42-4"><a href="#cb42-4"></a>    d &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(<span class="st">"downloads_rolling.rds"</span>)</span>
<span id="cb42-5"><a href="#cb42-5"></a>    <span class="op">!!</span>output<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>()</span>
<span id="cb42-6"><a href="#cb42-6"></a>  }, </span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="dt">patchCalls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</span>
<span id="cb42-8"><a href="#cb42-8"></a>    <span class="dt">downloads_rolling =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(d)</span>
<span id="cb42-9"><a href="#cb42-9"></a>  )</span>
<span id="cb42-10"><a href="#cb42-10"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb43-2"><a href="#cb43-2"></a>d &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(<span class="st">"downloads_rolling.rds"</span>)</span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(d, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Seven day rolling average"</span>)</span></code></pre></div>
<p>There are likely many other use cases where the low-level meta-programming capabilties of <code><a href="../reference/expandCode.html">expandCode()</a></code> becomes useful, but we think these will be the most common use cases. Remember, as with <code><a href="../reference/expandCode.html">expandObjects()</a></code>, it’s pretty easy to generate code that’s incorrect to make sure to test that the code you’re generating runs successfully!</p>
</div>
</div>
<div id="future-work" class="section level2">
<h2 class="hasAnchor">
<a href="#future-work" class="anchor"></a>Future work</h2>
<p><strong>shinymeta</strong> is very much an experiment and a work in progress. Some obvious ideas to invest in going forward:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/expandCode.html">expandObjects()</a></code> is a convenient wrapper over <code><a href="../reference/expandCode.html">expandCode()</a></code> in that you only need to provide a list of the meta-reactive expressions, outputs, and observers you care about. But you still have to provide <em>all</em> of these objects by name, and in the correct dependency order. It would be nicer to have a function that takes merely the outputs and observers you care about, and <em>automatically infers</em> the relevant meta-reactive expressions and their correct order.</li>
<li>R’s language objects effectively strip all comments and insignificant whitespace from the original source code. We’re using comment-strings as a workaround for the former, but we don’t currently have a solution for the latter, making shinymeta-generated code harder to read than it ought to be. In the future, we could use <a href="https://journal.r-project.org/archive/2010-2/RJournal_2010-2_Murdoch.pdf">source references</a> to reverse-engineer the code author’s desired whitespace.</li>
</ol>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>This is so common that you should be a bit skeptical if you see <code>input$xxx</code> without <code>!!</code> inside of any meta-reactive.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>If meta mode is not enabled, <code>output$OUTPUT_ID()</code> will intentionally produce an error.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#example">Meta-fying the cranview app</a></li>
      <li><a href="#meta-reactives">Meta-reactives</a></li>
      <li><a href="#unquoting">Unquoting with <code>!!</code></a></li>
      <li><a href="#chaining-meta-reactives">Chaining meta-reactives</a></li>
      <li><a href="#observers">Other meta-reactives (observers &amp; outputs)</a></li>
      <li><a href="#ignoring-code">Ignoring code</a></li>
      <li><a href="#putting-it-altogether">Putting it altogether</a></li>
      <li><a href="#future-work">Future work</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Joe Cheng, Carson Sievert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
