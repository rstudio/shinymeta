<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Introduction to shinymeta • shinymeta</title>

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Introduction to shinymeta" />

<meta property="og:description" content="" />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shinymeta</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/shinymeta.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/shinymeta1.html">Introduction to shinymeta</a>
    </li>
  </ul>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>


<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction to shinymeta</h1>
                        <h4 class="author">Joe Cheng</h4>
            
            <h4 class="date">2019-06-21</h4>
      
      
      <div class="hidden name"><code>shinymeta1.Rmd</code></div>

    </div>

    
    
<div id="introducing-shinymeta" class="section level1">
<h1>Introducing <code>shinymeta</code></h1>
<p>Our goal: allow the creation of Shiny apps that you use interactively, then produce reproducible scripts/report from.</p>
<p>Our inspiration: the concepts of metaprogramming, i.e., code that generates code.</p>
<p>Our solution: shinymeta!</p>
<div id="example-before-shinymeta" class="section level2">
<h2>Example: Before shinymeta</h2>
<p>Here’s a very simple, traditional Shiny app, with no meta anything (yet). Based on a CRAN package name provided by the user, it downloads a year’s worth of download data, then plots a 7-day rolling average.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="kw">textInput</span>(<span class="st">&quot;package&quot;</span>, <span class="st">&quot;Package name&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;ggplot2&quot;</span>),</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb1-8"><a href="#cb1-8"></a>)</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {</span>
<span id="cb1-11"><a href="#cb1-11"></a>  downloads &lt;-<span class="st"> </span><span class="kw">reactive</span>({</span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="co"># Retrieve a year&#39;s worth of daily download data</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb1-14"><a href="#cb1-14"></a>  })</span>
<span id="cb1-15"><a href="#cb1-15"></a>  </span>
<span id="cb1-16"><a href="#cb1-16"></a>  downloads_rolling &lt;-<span class="st"> </span><span class="kw">reactive</span>({</span>
<span id="cb1-17"><a href="#cb1-17"></a>    <span class="co"># Convert daily data to 7 day rolling average</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw">rollapply</span>(count, <span class="dv">7</span>, mean, <span class="dt">fill=</span><span class="st">&quot;extend&quot;</span>))</span>
<span id="cb1-19"><a href="#cb1-19"></a>  })</span>
<span id="cb1-20"><a href="#cb1-20"></a>  </span>
<span id="cb1-21"><a href="#cb1-21"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb1-22"><a href="#cb1-22"></a>    <span class="kw">ggplot</span>(<span class="kw">downloads_rolling</span>(), <span class="kw">aes</span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seven day rolling average&quot;</span>)</span>
<span id="cb1-23"><a href="#cb1-23"></a>  })</span>
<span id="cb1-24"><a href="#cb1-24"></a>}</span>
<span id="cb1-25"><a href="#cb1-25"></a></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co"># shinyApp(ui, server)</span></span></code></pre></div>
<div id="example-after-shinymeta" class="section level3">
<h3>Example: After shinymeta</h3>
<p>Now, let’s add a panel that shows R code you can use to reproduce this plot in a separate R process. There are lots of different ways to present code in shinymeta, but for now we’ll do it as simply as possible, with a <code>verbatimTextOutput</code> and <code>renderPrint</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a>ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(</span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="kw">textInput</span>(<span class="st">&quot;package&quot;</span>, <span class="st">&quot;Package name&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;ggplot2&quot;</span>),</span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;code&quot;</span>),</span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="kw">plotOutput</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb2-9"><a href="#cb2-9"></a>)</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {</span>
<span id="cb2-12"><a href="#cb2-12"></a>  downloads &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb2-13"><a href="#cb2-13"></a>    cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb2-14"><a href="#cb2-14"></a>  })</span>
<span id="cb2-15"><a href="#cb2-15"></a>  </span>
<span id="cb2-16"><a href="#cb2-16"></a>  downloads_rolling &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="op">!!</span><span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw">rollapply</span>(count, <span class="dv">7</span>, mean, <span class="dt">fill=</span><span class="st">&quot;extend&quot;</span>))</span>
<span id="cb2-18"><a href="#cb2-18"></a>  })</span>
<span id="cb2-19"><a href="#cb2-19"></a>  </span>
<span id="cb2-20"><a href="#cb2-20"></a>  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">metaRender</span>(renderPlot, {</span>
<span id="cb2-21"><a href="#cb2-21"></a>    <span class="kw">ggplot</span>(<span class="op">!!</span><span class="kw">downloads_rolling</span>(), <span class="kw">aes</span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seven day rolling average&quot;</span>)</span>
<span id="cb2-22"><a href="#cb2-22"></a>  })</span>
<span id="cb2-23"><a href="#cb2-23"></a>  </span>
<span id="cb2-24"><a href="#cb2-24"></a>  output<span class="op">$</span>code &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({</span>
<span id="cb2-25"><a href="#cb2-25"></a>    <span class="kw">expandCode</span>({</span>
<span id="cb2-26"><a href="#cb2-26"></a>      <span class="kw">library</span>(ggplot2)</span>
<span id="cb2-27"><a href="#cb2-27"></a>      <span class="kw">library</span>(dplyr)</span>
<span id="cb2-28"><a href="#cb2-28"></a>      </span>
<span id="cb2-29"><a href="#cb2-29"></a>      <span class="op">!!</span>output<span class="op">$</span><span class="kw">plot</span>()</span>
<span id="cb2-30"><a href="#cb2-30"></a>    })</span>
<span id="cb2-31"><a href="#cb2-31"></a>  })</span>
<span id="cb2-32"><a href="#cb2-32"></a>}</span>
<span id="cb2-33"><a href="#cb2-33"></a></span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="co"># shinyApp(ui, server)</span></span></code></pre></div>
<p>You’ll notice that the code that the app displays isn’t particularly nice, nor is the way the code is being displayed. Don’t worry, we’re going to come back and clean that up by the end of this document. But for now, let’s focus on the changes we see here:</p>
<ol style="list-style-type: decimal">
<li>Each <code>reactive()</code> has changed to <code>metaReactive()</code>, and the <code>renderPlot</code> has been jammed into a <code>metaRender()</code> function.</li>
<li>Each read of a <code>metaReactive</code> or <code>input</code> value has been prepended with <code>!!</code>.</li>
<li>Added a new <code>code</code> output and implemented it using <code>renderPrint</code> and <code>expandCode</code>.</li>
</ol>
<p>These changes don’t look dramatic, but in order for you to really understand how this all works, we’ll need to peel back the onion a few layers and delve into the implementation of shinymeta.</p>
</div>
</div>
<div id="generating-code-from-reactive-objects" class="section level2">
<h2>Generating code from reactive objects</h2>
<p>Let’s zoom in on this reactive expression from the original version app:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">reactive</span>({</span>
<span id="cb3-2"><a href="#cb3-2"></a>  cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb3-3"><a href="#cb3-3"></a>})</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">downloads</span>()</span></code></pre></div>
<pre><code>##         date count package
## 1 2018-06-21 16835 ggplot2
## 2 2018-06-22 15204 ggplot2
## 3 2018-06-23  8452 ggplot2
## 4 2018-06-24 10206 ggplot2
## 5 2018-06-25 15367 ggplot2
## 6 2018-06-26 17687 ggplot2
## [...plus 360 more rows...]</code></pre>
<p>Reactive expressions are fantastic at the job they were designed for: lazy, caching, reactivity-aware calculators of results. But they don’t help us with the second part of our goal, which is extracting the essential logic of the app’s reactive objects.</p>
<p>Enter <code>metaReactive</code>. Let’s do nothing besides change <code>reactive</code> to <code>metaReactive</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb5-2"><a href="#cb5-2"></a>  cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb5-3"><a href="#cb5-3"></a>})</span></code></pre></div>
<pre><code>## Registered S3 method overwritten by &#39;fastmap&#39;:
##   method            from 
##   print.key_missing shiny</code></pre>
<p>In normal usage, the behavior of <code>downloads</code> doesn’t change at all—it still works exactly the same as it lazily, cachingly, reactivity-aware-ingly calculates results.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">downloads</span>()</span></code></pre></div>
<pre><code>##         date count package
## 1 2018-06-21 16835 ggplot2
## 2 2018-06-22 15204 ggplot2
## 3 2018-06-23  8452 ggplot2
## 4 2018-06-24 10206 ggplot2
## 5 2018-06-25 15367 ggplot2
## 6 2018-06-26 17687 ggplot2
## [...plus 360 more rows...]</code></pre>
<p>But when we call it under the influence of a new function, <code>shinymeta::withMetaMode</code>, suddenly its behavior changes: (TODO: introduce expandCode, point out lack of !!)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads</span>())</span></code></pre></div>
<pre><code>## cranlogs::cran_downloads(input$package, from = Sys.Date() - 365, to = Sys.Date())</code></pre>
<p>Instead of getting a data frame, we get code!</p>
<p>We’ll soon talk about what to do with the returned code. But first, let’s look at how we can customize and control the generated code.</p>
<div id="expanding-values-with-the-unquote-operator" class="section level3">
<h3>Expanding values with the unquote (<code>!!</code>) operator</h3>
<p>If you try to run the code we just generated in a new R session, you’ll find it doesn’t work. The code contains a reference to <code>input$package</code>, which only works in a live Shiny session. No problem! We can use the <code>!!</code> operator to tell <code>metaReactive</code> to <em>unquote</em> <code>input$package</code>; that is, insert the value of <code>input$package</code> into the code rather than the literal code “<code>input$package</code>”.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb11-2"><a href="#cb11-2"></a>  cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb11-3"><a href="#cb11-3"></a>})</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads</span>())</span></code></pre></div>
<pre><code>## cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())</code></pre>
<p>This is so common that you should be a bit skeptical if you see <code>input$xxx</code> without <code>!!</code> inside of any meta-reactive.</p>
<p>Depending on the ultimate purpose of the script we generate, we may or may not also want to replace the <code>Sys.Date()</code> calls (which return the current date) with their actual values: do we want the generated script to always use <code>Sys.Date()</code>, or hard-code today’s date when the script is generated? If the latter, we can again use unquoting to accomplish this.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb13-2"><a href="#cb13-2"></a>  cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="op">!!</span>(<span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>), <span class="dt">to =</span> <span class="op">!!</span><span class="kw">Sys.Date</span>())</span>
<span id="cb13-3"><a href="#cb13-3"></a>})</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads</span>())</span></code></pre></div>
<pre><code>## cranlogs::cran_downloads(&quot;ggplot2&quot;, from = structure(17703, class = &quot;Date&quot;), to = structure(18068, class = &quot;Date&quot;))</code></pre>
<p>Ack, gross! The resulting objects work, but are pretty ugly (they are the result of <code>deparse(Sys.Date())</code>). Let’s change them to <code>"yyyy-MM-dd"</code> strings using the <code>format</code> function:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb15-2"><a href="#cb15-2"></a>  cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="op">!!</span><span class="kw">format</span>(<span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>), <span class="dt">to =</span> <span class="op">!!</span><span class="kw">format</span>(<span class="kw">Sys.Date</span>()))</span>
<span id="cb15-3"><a href="#cb15-3"></a>})</span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads</span>())</span></code></pre></div>
<pre><code>## cranlogs::cran_downloads(&quot;ggplot2&quot;, from = &quot;2018-06-21&quot;, to = &quot;2019-06-21&quot;)</code></pre>
<p>Unquoting is an essential tool for fine-grained customization of the generated code. For other scenarios, you may need coarser-grained control, which is where <code>metaReactive2</code> comes in.</p>
</div>
<div id="selective-quotation-with-metareactive2metaexpr" class="section level3">
<h3>Selective quotation with <code>metaReactive2</code>/<code>metaExpr</code></h3>
<p>The apps above had an unsightly bug: if the user clears the Package text box, you get an error “Invalid query, probably invalid dates”. We can add a <code>validate(need(...))</code> statement to make this error nicer:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="kw">validate</span>(<span class="kw">need</span>(input<span class="op">$</span>package, <span class="st">&quot;Please provide a package name&quot;</span>))</span>
<span id="cb17-3"><a href="#cb17-3"></a>  cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb17-4"><a href="#cb17-4"></a>})</span></code></pre></div>
<p>Unfortunately, this now means our essential logic contains this decidedly unessential validation statement:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads</span>())</span></code></pre></div>
<pre><code>## validate(need(input$package, &quot;Please provide a package name&quot;))
## cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())</code></pre>
<p>We need <code>validate</code>/<code>need</code> to be called during interactive use, but we don’t want it included as part of the exported code. For these situations, shinymeta includes a second version of <code>metaReactive</code>, unimaginatively named <code>metaReactive2</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive2</span>({</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="kw">validate</span>(<span class="kw">need</span>(input<span class="op">$</span>package, <span class="st">&quot;Please provide a package name&quot;</span>))</span>
<span id="cb20-3"><a href="#cb20-3"></a>  </span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="kw">metaExpr</span>({</span>
<span id="cb20-5"><a href="#cb20-5"></a>    cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb20-6"><a href="#cb20-6"></a>  })</span>
<span id="cb20-7"><a href="#cb20-7"></a>})</span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads</span>())</span></code></pre></div>
<pre><code>## cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())</code></pre>
<p><code>metaReactive</code> and <code>metaReactive2</code> have largely identical behavior, except for this one thing: <code>metaReactive</code> treats its entire code body as export-worthy code, but <code>metaReactive2</code> requires you to explicitly wrap the export-worthy part of your code in <code>metaExpr(...)</code>, and return it.</p>
<p><em>Note:</em> The last part of that sentence is important! The result of <code>metaExpr</code> must be <em>returned</em> from the <code>metaReactive2</code> expression, or it won’t be used as the code. Neither of these examples would work as desired, for example:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>wrong1 &lt;-<span class="st"> </span><span class="kw">metaReactive2</span>({</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="co"># Will not be part of exported code, because it&#39;s not the last expression</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="kw">metaExpr</span>({</span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="kw">important_operation</span>(data)</span>
<span id="cb22-5"><a href="#cb22-5"></a>  })</span>
<span id="cb22-6"><a href="#cb22-6"></a>  </span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="ot">NULL</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>})</span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="kw">withMetaMode</span>(<span class="kw">wrong1</span>())</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>wrong2 &lt;-<span class="st"> </span><span class="kw">metaReactive2</span>({</span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="co"># Will not be part of exported code</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="kw">metaExpr</span>({</span>
<span id="cb24-4"><a href="#cb24-4"></a>    <span class="kw">do_something</span>()</span>
<span id="cb24-5"><a href="#cb24-5"></a>  })</span>
<span id="cb24-6"><a href="#cb24-6"></a>  </span>
<span id="cb24-7"><a href="#cb24-7"></a>  <span class="co"># Will be entirety of exported code</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>  <span class="kw">metaExpr</span>({</span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="kw">do_something_else</span>()</span>
<span id="cb24-10"><a href="#cb24-10"></a>  })</span>
<span id="cb24-11"><a href="#cb24-11"></a>})</span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="kw">withMetaMode</span>(<span class="kw">wrong2</span>())</span></code></pre></div>
<pre><code>## do_something_else()</code></pre>
</div>
<div id="meta-reactive-objects-explained" class="section level3">
<h3>Meta reactive objects explained</h3>
<p>We have just seen the syntax for <code>metaReactive</code> and <code>metaReactive2</code>/<code>metaExpr</code>. Now let’s talk about how these dual-mode reactive objects are implemented. (For the purposes of this discussion, we’ll mostly ignore <code>metaReactive</code>, as it’s basically just <code>metaReactive2</code> but with an implicit <code>metaExpr</code> around the whole code body.)</p>
<p>The humble truth is that behind all of this dual-mode reactive fanciness is just a global variable, in the form of the <code>shinymeta::metaMode()</code> function. Call it with no arguments to read it:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">metaMode</span>()</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>And call it with a single logical to write to it:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw">metaMode</span>(<span class="ot">TRUE</span>)  <span class="co"># Don&#39;t actually do this, probably.</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="kw">metaMode</span>()</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">metaMode</span>(<span class="ot">FALSE</span>) <span class="co"># Restore default value, phew!</span></span></code></pre></div>
<p>The <code>withMetaMode</code> function we’ve been using does little more than set the <code>metaMode</code> variable (to <code>TRUE</code>, by default), evaluates the expression you give it, then restores <code>metaMode</code> to its previous value. It’s highly unlikely you’d ever want to turn on <code>metaMode</code> and leave it that way, so, avoid setting <code>metaMode</code> directly and use <code>withMetaMode</code> instead–or better yet, the even higher level <code>expandCode</code> function we’ll soon get to.</p>
</div>
<div id="going-meta-with-observers-and-outputs" class="section level3">
<h3>Going meta with observers and outputs</h3>
<p>So far, we’ve only looked at meta-enabled versions of reactive expressions. The other two fundamental reactive object types are observers and outputs, and we need the ability to pull code out of those as well.</p>
<div id="metaobservemetaobserve2" class="section level4">
<h4><code>metaObserve</code>/<code>metaObserve2</code></h4>
<p>Observers are easy; just as <code>reactive()</code> has <code>metaReactive</code>/<code>metaReactive2</code>, <code>observe()</code> has <code>metaObserve</code>/<code>metaObserve2</code>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">observe</span>({</span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="kw">message</span>(<span class="st">&quot;Package selected:&quot;</span>, input<span class="op">$</span>package)</span>
<span id="cb31-3"><a href="#cb31-3"></a>})</span></code></pre></div>
<p>becomes:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>msgObs &lt;-<span class="st"> </span><span class="kw">metaObserve</span>({</span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="kw">message</span>(<span class="st">&quot;Package selected:&quot;</span>, <span class="op">!!</span>input<span class="op">$</span>package)</span>
<span id="cb32-3"><a href="#cb32-3"></a>})</span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="kw">withMetaMode</span>(<span class="kw">msgObs</span>())</span></code></pre></div>
<pre><code>## message(&quot;Package selected:&quot;, &quot;ggplot2&quot;)</code></pre>
<p>The traditional <code>observe()</code> function returns an object that can be used to control aspects of the observer, though most Shiny apps don’t bother to save it. See <code>?observe</code> for the different methods available. The object returned from <code>metaObserve</code> can be used in the same way (<code>msgObs$suspend()</code>, for example) but has the additional capability of being called like a function, as in the previous code example.</p>
<p><code>metaObserve2</code> works exactly like <code>metaReactive2</code>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>msgObs &lt;-<span class="st"> </span><span class="kw">metaObserve2</span>({</span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="kw">req</span>(input<span class="op">$</span>package) <span class="co"># Validation code; not for export</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>  </span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="kw">metaExpr</span>({</span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="kw">message</span>(<span class="st">&quot;Package selected:&quot;</span>, <span class="op">!!</span>input<span class="op">$</span>package)</span>
<span id="cb34-6"><a href="#cb34-6"></a>  })</span>
<span id="cb34-7"><a href="#cb34-7"></a>})</span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="kw">withMetaMode</span>(<span class="kw">msgObs</span>())</span></code></pre></div>
<pre><code>## message(&quot;Package selected:&quot;, &quot;ggplot2&quot;)</code></pre>
</div>
<div id="metarendermetarender2" class="section level4">
<h4><code>metaRender</code>/<code>metaRender2</code></h4>
<p>When it comes to outputs, things are not quite as simple. Here’s the original plotting code:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="kw">ggplot</span>(<span class="kw">downloads_rolling</span>(), <span class="kw">aes</span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seven day rolling average&quot;</span>)</span>
<span id="cb36-3"><a href="#cb36-3"></a>})</span></code></pre></div>
<p>The simplest solution would be if we had a <code>metaRenderPlot</code> function that could stand in for <code>renderPlot</code>, in exactly the same vein as <code>metaReactive</code>. But <code>renderPlot</code> is just one of several output render functions that come with Shiny, and many dozens of other output render functions exist in third party R packages. It would be unwieldy to try to provide <code>meta</code>-prefixed versions of all of these functions in shinymeta.</p>
<p>Instead, we created a general-purpose <code>metaRender</code> function that can be used with any output render function. This generality comes at the cost of a somewhat awkward syntax: <code>renderPlot({</code> becomes <code>metaRender(renderPlot, {</code>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">metaRender</span>(renderPlot, {</span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="kw">ggplot</span>(<span class="kw">downloads_rolling</span>(), <span class="kw">aes</span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seven day rolling average&quot;</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a>})</span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="kw">withMetaMode</span>(output<span class="op">$</span><span class="kw">plot</span>())</span></code></pre></div>
<pre><code>## ggplot(downloads_rolling(), aes(date, count)) + geom_line() + ggtitle(&quot;Seven day rolling average&quot;)</code></pre>
<p>You can call <code>output$plot()</code> like a function, inside of <code>withMetaMode</code>, to get the code out. (You may not call <code>output$plot()</code> for any other reason, i.e. outside of <code>withMetaMode</code>–you will just get an error.)</p>
<p>(<code>metaRender</code> makes some assumptions about the arguments taken by the render function, assumptions that we believe are true for all existing render functions. If you encounter a render function that doesn’t seem to work properly with shinymeta, please let us know by <a href="https://github.com/rstudio/shinymeta/issues">filing an issue on GitHub</a>.)</p>
<p>Finally, we won’t bother with an example, but <code>metaRender2</code> is available as well, for the same purpose as the other -<code>2</code> functions.</p>
</div>
</div>
</div>
<div id="combining-meta-reactives" class="section level2">
<h2>Combining meta-reactives</h2>
<p>Now you know how to create reactive expressions, observers, and outputs that can return their own logic. So far, we’ve glossed over the fact that such objects can (and usually do) have relationships with each other: reactive expressions can be called by other reactive expressions, observers, and outputs.</p>
<p>Consider these two <code>metaReactive</code>s:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>downloads &lt;-<span class="st"> </span><span class="kw">metaReactive2</span>({</span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="kw">validate</span>(<span class="kw">need</span>(input<span class="op">$</span>package, <span class="st">&quot;Please provide a package name&quot;</span>))</span>
<span id="cb39-3"><a href="#cb39-3"></a>  </span>
<span id="cb39-4"><a href="#cb39-4"></a>  <span class="kw">metaExpr</span>({</span>
<span id="cb39-5"><a href="#cb39-5"></a>    cranlogs<span class="op">::</span><span class="kw">cran_downloads</span>(<span class="op">!!</span>input<span class="op">$</span>package, <span class="dt">from =</span> <span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span><span class="dv">365</span>, <span class="dt">to =</span> <span class="kw">Sys.Date</span>())</span>
<span id="cb39-6"><a href="#cb39-6"></a>  })</span>
<span id="cb39-7"><a href="#cb39-7"></a>})</span>
<span id="cb39-8"><a href="#cb39-8"></a></span>
<span id="cb39-9"><a href="#cb39-9"></a>downloads_rolling &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb39-10"><a href="#cb39-10"></a>  <span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw">rollapply</span>(count, <span class="dv">7</span>, mean, <span class="dt">fill=</span><span class="st">&quot;extend&quot;</span>))</span>
<span id="cb39-11"><a href="#cb39-11"></a>})</span></code></pre></div>
<p>Here, <code>downloads_rolling</code> calls <code>downloads</code>. When we retrieve the code for <code>downloads_rolling</code>, it contains a reference to <code>downloads</code>:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads_rolling</span>())</span></code></pre></div>
<pre><code>## downloads() %&gt;%
##   mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))</code></pre>
<p>This isn’t reproducible code on its own, as the definition for <code>downloads</code> won’t exist in a new R session.</p>
<p>In previous sections, we used <code>!!</code> to insert values where there was code. But when you use <code>!!</code> with a call to a <code>metaReactive</code> object like <code>downloads</code>, it’s that object’s <em>code</em> that gets inserted, not its value.</p>
<p>Therefore, we can inline the code for <code>downloads</code> into <code>downloads_rolling</code> by simply unquoting the call to <code>downloads</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>downloads_rolling &lt;-<span class="st"> </span><span class="kw">metaReactive</span>({</span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="op">!!</span><span class="kw">downloads</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">count =</span> zoo<span class="op">::</span><span class="kw">rollapply</span>(count, <span class="dv">7</span>, mean, <span class="dt">fill=</span><span class="st">&quot;extend&quot;</span>))</span>
<span id="cb42-3"><a href="#cb42-3"></a>})</span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="kw">withMetaMode</span>(<span class="kw">downloads_rolling</span>())</span></code></pre></div>
<pre><code>## {
##   cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## } %&gt;%
##   mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))</code></pre>
<p>To summarize everything we’ve learned so far, we convert a Shiny app to shinymeta by:</p>
<ol style="list-style-type: decimal">
<li>Identifying all of the reactive expressions, observers, and outputs that represent logic we want to export, and change them into <code>metaReactive</code>, <code>metaObserve</code>, and <code>metaRender</code>, respectively (or <code>metaReactive2</code>, <code>metaObserve2</code>, and <code>metaRender2</code> if you want to be more selective about parts of their code blocks you want to export).</li>
<li>Use <code>!!</code> to unquote <code>input$xxx</code>, calls to <code>metaReactive</code> objects, and any other expressions that you do not want to literally be part of the exported code.</li>
</ol>
<p>There are two more significant steps in the code generation process, both of which are handled through the <code>expandCode</code> function we’ll introduce now.</p>
</div>
<div id="code-expansion-with-expandcode" class="section level2">
<h2>Code expansion with… <code>expandCode</code></h2>
<p>We’ve demonstrated that once you’ve used the previous steps to convert and annotate your reactive objects, you can use <code>withMetaMode()</code> to retrieve the code from any object. But we usually want to generate chunks of code that bring together <em>multiple</em> distinct reactive objects (say, more than one output).</p>
<p>Let’s say we introduce a second output for our app, like a printed summary of the download counts.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>output<span class="op">$</span>summary &lt;-<span class="st"> </span><span class="kw">metaRender</span>(renderPrint, {</span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="kw">summary</span>((<span class="op">!!</span><span class="kw">downloads</span>())<span class="op">$</span>count)</span>
<span id="cb44-3"><a href="#cb44-3"></a>})</span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="kw">withMetaMode</span>(output<span class="op">$</span><span class="kw">summary</span>())</span></code></pre></div>
<pre><code>## summary({
##   cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## }$count)</code></pre>
<p>And let’s re-implement <code>output$plot</code>, using everything we’ve learned so far.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">metaRender</span>(renderPlot, {</span>
<span id="cb46-2"><a href="#cb46-2"></a>  <span class="kw">ggplot</span>(<span class="op">!!</span><span class="kw">downloads_rolling</span>(), <span class="kw">aes</span>(date, count)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seven day rolling average&quot;</span>)</span>
<span id="cb46-3"><a href="#cb46-3"></a>})</span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="kw">withMetaMode</span>(output<span class="op">$</span><span class="kw">plot</span>())</span></code></pre></div>
<pre><code>## ggplot({
##   {
##     cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
##   } %&gt;%
##     mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))
## }, aes(date, count)) + geom_line() + ggtitle(&quot;Seven day rolling average&quot;)</code></pre>
<p>Now we have two outputs, <code>output$plot</code> and <code>output$summary</code>. The <code>expandCode</code> function gives us a way to conveniently bring these two pieces of code together. You call it with a code expression that contains unquoted (<code>!!</code>) subexpressions, and it expands those subexpressions within a <code>withMetaMode</code> scope.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="kw">expandCode</span>({</span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="st">&quot;# A summary of output counts&quot;</span></span>
<span id="cb48-3"><a href="#cb48-3"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">summary</span>()</span>
<span id="cb48-4"><a href="#cb48-4"></a>  <span class="st">&quot;# A plot&quot;</span></span>
<span id="cb48-5"><a href="#cb48-5"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">plot</span>()</span>
<span id="cb48-6"><a href="#cb48-6"></a>})</span></code></pre></div>
<pre><code>## # A summary of output counts
## summary({
##   cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## }$count)
## # A plot
## ggplot({
##   {
##     cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
##   } %&gt;%
##     mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))
## }, aes(date, count)) + geom_line() + ggtitle(&quot;Seven day rolling average&quot;)</code></pre>
<p>You’re not limited to just outputs; you can also introduce variables for meta-reactive expressions that you think might be interesting to the ultimate recipient of the code.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="kw">expandCode</span>({</span>
<span id="cb50-2"><a href="#cb50-2"></a>  <span class="st">&quot;# Data frame of package downloads&quot;</span></span>
<span id="cb50-3"><a href="#cb50-3"></a>  pkg_downloads &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="st">&quot;# A summary of output counts&quot;</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">summary</span>()</span>
<span id="cb50-6"><a href="#cb50-6"></a>  <span class="st">&quot;# A plot&quot;</span></span>
<span id="cb50-7"><a href="#cb50-7"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">plot</span>()</span>
<span id="cb50-8"><a href="#cb50-8"></a>})</span></code></pre></div>
<pre><code>## # Data frame of package downloads
## pkg_downloads &lt;- cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## # A summary of output counts
## summary({
##   cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## }$count)
## # A plot
## ggplot({
##   {
##     cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
##   } %&gt;%
##     mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))
## }, aes(date, count)) + geom_line() + ggtitle(&quot;Seven day rolling average&quot;)</code></pre>
<div id="refactoring-to-remove-duplicated-code" class="section level3">
<h3>Refactoring to remove duplicated code</h3>
<p>The code we generated in the previous section has a serious problem. The <code>output$plot</code> and <code>output$summary</code> outputs both depend on <code>downloads()</code>, directly or indirectly; and we also saved <code>!!downloads()</code> to its own <code>pkg_downloads</code> variable. Now there are <em>three</em> identical calls to <code>cranlogs::cran_downloads()</code> in this small snippet of code!</p>
<p>This is problematic for several reasons. First, it makes the code harder to read and understand. Second, any changes to the logic by the recipient of the code will need to be done thrice, which is both tedious and error-prone. And finally, the duplication of logic may introduce bugs if the logic in <code>downloads()</code> has side effects or returns different results each time it is run (i.e. having an element of randomness).</p>
<p>For now, our solution to this problem is extremely targeted (or, less charitably, an ugly hack): <code>expandCode</code> includes we support for <a href="https://en.wikipedia.org/wiki/Monkey_patch">monkey patching</a> your meta-reactive objects. You pass it a <code>patchCalls</code> argument, which is a named list.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="kw">expandCode</span>({</span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="st">&quot;# Data frame of package downloads&quot;</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>  pkg_downloads &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="st">&quot;# A summary of output counts&quot;</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">summary</span>()</span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="st">&quot;# A plot&quot;</span></span>
<span id="cb52-7"><a href="#cb52-7"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">plot</span>()</span>
<span id="cb52-8"><a href="#cb52-8"></a>}, <span class="dt">patchCalls =</span> <span class="kw">list</span>(</span>
<span id="cb52-9"><a href="#cb52-9"></a>  <span class="dt">downloads =</span> <span class="kw">quote</span>(pkg_downloads)</span>
<span id="cb52-10"><a href="#cb52-10"></a>))</span></code></pre></div>
<pre><code>## # Data frame of package downloads
## pkg_downloads &lt;- cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## # A summary of output counts
## summary(pkg_downloads$count)
## # A plot
## ggplot({
##   pkg_downloads %&gt;%
##     mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))
## }, aes(date, count)) + geom_line() + ggtitle(&quot;Seven day rolling average&quot;)</code></pre>
<p>For this example, <code>patchCalls</code> has a single entry: <code>downloads = quote(pkg_downloads)</code>. This means, "anytime <code>downloads()</code> is invoked by a meta-reactive object, return <code>quote(pkg_downloads)</code> (i.e. the symbol <code>pkg_downloads</code>).</p>
<p>(Note that we chose to use <code>pkg_downloads</code>, not <code>downloads</code>, as the variable name for <code>downloads()</code>. There’s nothing to stop us from using the more obvious variable name <code>downloads</code>, but for the purpose of introducing the concept, changing the variable name makes it easier to understand how to use <code>patchCalls</code>.)</p>
<p>Unquoted subexpressions at the top level of <code>expandCode</code>–like the <code>!!downloads()</code> in <code>pkg_downloads &lt;- !!downloads()</code>–are <em>not</em> affected by <code>patchCalls</code>. Only unquoted subexpressions nested within those subexpressions are affected, such as the <code>!!downloads()</code> inside of <code>!!output$summary()</code>. This may seem like a strange design decision, but it simplified all of the examples we tried.</p>
<div id="refactor-with-caution" class="section level4">
<h4>Refactor with caution</h4>
<p><code>patchCalls</code> is a useful feature that can clean up your code considerably, but be aware that this is a pretty blunt instrument. Imagine that we now want to further clean up the code by extracting our <code>downloads_rolling</code> meta-reactive into a variable; even though <code>downloads_rolling()</code> is only used in a single place, giving it a named variable makes its intent clearer, and makes the plotting code easier to understand.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="kw">expandCode</span>({</span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="st">&quot;# Seven-day rolling average of download counts&quot;</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>  downloads_rolling &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads_rolling</span>()</span>
<span id="cb54-4"><a href="#cb54-4"></a>  </span>
<span id="cb54-5"><a href="#cb54-5"></a>  <span class="st">&quot;# Data frame of package downloads&quot;</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>  pkg_downloads &lt;-<span class="st"> </span><span class="op">!!</span><span class="kw">downloads</span>()</span>
<span id="cb54-7"><a href="#cb54-7"></a>  </span>
<span id="cb54-8"><a href="#cb54-8"></a>  <span class="st">&quot;# A summary of output counts&quot;</span></span>
<span id="cb54-9"><a href="#cb54-9"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">summary</span>()</span>
<span id="cb54-10"><a href="#cb54-10"></a>  </span>
<span id="cb54-11"><a href="#cb54-11"></a>  <span class="st">&quot;# A plot&quot;</span></span>
<span id="cb54-12"><a href="#cb54-12"></a>  <span class="op">!!</span>output<span class="op">$</span><span class="kw">plot</span>()</span>
<span id="cb54-13"><a href="#cb54-13"></a>  </span>
<span id="cb54-14"><a href="#cb54-14"></a>}, <span class="dt">patchCalls =</span> <span class="kw">list</span>(</span>
<span id="cb54-15"><a href="#cb54-15"></a>  <span class="dt">downloads =</span> <span class="kw">quote</span>(pkg_downloads),</span>
<span id="cb54-16"><a href="#cb54-16"></a>  <span class="dt">downloads_rolling =</span> <span class="kw">quote</span>(downloads_rolling)</span>
<span id="cb54-17"><a href="#cb54-17"></a>))</span></code></pre></div>
<pre><code>## # Seven-day rolling average of download counts
## downloads_rolling &lt;- pkg_downloads %&gt;%
##   mutate(count = zoo::rollapply(count, 7, mean, fill = &quot;extend&quot;))
## # Data frame of package downloads
## pkg_downloads &lt;- cranlogs::cran_downloads(&quot;ggplot2&quot;, from = Sys.Date() - 365, to = Sys.Date())
## # A summary of output counts
## summary(pkg_downloads$count)
## # A plot
## ggplot(downloads_rolling, aes(date, count)) + geom_line() + ggtitle(&quot;Seven day rolling average&quot;)</code></pre>
<p>The generated code looks clean, but it’s wrong! <code>downloads_rolling</code> uses <code>pkg_downloads</code> before <code>pkg_downloads</code> exists. <code>expandCode</code> is not smart enough to detect this and warn, much less fix the problem for you automatically.</p>
<p>Just as you carefully test your Shiny app’s behavior to ensure it does what you intend, you need to carefully inspect/test your generated code for correctness as well–and this goes double when <code>patchCalls</code> is involved.</p>
</div>
</div>
</div>
<div id="exporting-code" class="section level2">
<h2>Exporting code</h2>
<p>TODO: 1. code preview box, 2. “Show R code” button, 3. download script/report bundle</p>
</div>
<div id="section" class="section level2">
<h2></h2>
<p>TODO: explain exportCode</p>
<p>TODO: explain patchCode</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul>
      <li><a href="#introducing-shinymeta">Introducing <code>shinymeta</code></a><ul>
      <li><a href="#example-before-shinymeta">Example: Before shinymeta</a></li>
      <li><a href="#generating-code-from-reactive-objects">Generating code from reactive objects</a></li>
      <li><a href="#combining-meta-reactives">Combining meta-reactives</a></li>
      <li><a href="#code-expansion-with-expandcode">Code expansion with… <code>expandCode</code></a></li>
      <li><a href="#exporting-code">Exporting code</a></li>
      <li><a href="#section"></a></li>
      </ul></li>
      </ul>
    </div>
      </div>

</div>


      <footer>
      <div class="copyright">
  <p>Developed by Joe Cheng.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
   </div>

  

  </body>
</html>
